@page "/products/{slug}"
@model MarketplaceBuilder.Storefront.Pages.Products.DetailsModel
@{
    ViewData["Title"] = Model.Product?.Title ?? "Product Details";
}

@if (Model.Product == null)
{
    <div class="container mt-5">
        <div class="alert alert-danger">
            <h2>Product Not Found</h2>
            <p>The product you're looking for doesn't exist or is no longer available.</p>
            <a href="/products" class="btn btn-primary">Back to Products</a>
        </div>
    </div>
}
else
{
    <div class="container mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/products">Products</a></li>
                @if (!string.IsNullOrEmpty(Model.Product.CategoryName))
                {
                    <li class="breadcrumb-item">@Model.Product.CategoryName</li>
                }
                <li class="breadcrumb-item active" aria-current="page">@Model.Product.Title</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Image Gallery -->
            <div class="col-md-6">
                @if (Model.Product.Images.Any())
                {
                    <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @for (int i = 0; i < Model.Product.Images.Count; i++)
                            {
                                var image = Model.Product.Images[i];
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@image.PublicUrl" class="d-block w-100" alt="@Model.Product.Title" style="max-height: 500px; object-fit: contain;">
                                </div>
                            }
                        </div>
                        @if (Model.Product.Images.Count > 1)
                        {
                            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        }
                    </div>
                }
                else if (!string.IsNullOrEmpty(Model.Product.PrimaryImageUrl))
                {
                    <img src="@Model.Product.PrimaryImageUrl" class="img-fluid" alt="@Model.Product.Title">
                }
                else
                {
                    <div class="bg-light d-flex align-items-center justify-content-center" style="height: 400px;">
                        <span class="text-muted">No image available</span>
                    </div>
                }
            </div>

            <!-- Product Info -->
            <div class="col-md-6">
                <h1 class="mb-3">@Model.Product.Title</h1>
                
                @if (!string.IsNullOrEmpty(Model.Product.CategoryName))
                {
                    <p class="text-muted">Category: <strong>@Model.Product.CategoryName</strong></p>
                }

                @if (Model.Product.DefaultVariant != null)
                {
                    <h2 class="text-primary mb-3">@Model.Product.DefaultVariant.FormattedPrice</h2>

                    @if (Model.Product.DefaultVariant.InStock)
                    {
                        <p class="text-success"><i class="bi bi-check-circle"></i> In Stock (@Model.Product.DefaultVariant.StockQty available)</p>
                    }
                    else
                    {
                        <p class="text-danger"><i class="bi bi-x-circle"></i> Out of Stock</p>
                    }
                }

                @if (!string.IsNullOrEmpty(Model.Product.Description))
                {
                    <div class="mt-4">
                        <h4>Description</h4>
                        <p>@Model.Product.Description</p>
                    </div>
                }

                <!-- Variants -->
                @if (Model.Product.Variants.Count > 1)
                {
                    <div class="mt-4">
                        <h4>Options</h4>
                        <div class="list-group">
                            @foreach (var variant in Model.Product.Variants)
                            {
                                <div class="list-group-item @(variant.IsDefault ? "active" : "")">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">@variant.Name</h5>
                                        <strong>@variant.FormattedPrice</strong>
                                    </div>
                                    @if (!string.IsNullOrEmpty(variant.Sku))
                                    {
                                        <p class="mb-1 small">SKU: @variant.Sku</p>
                                    }
                                    <small class="@(variant.InStock ? "text-success" : "text-danger")">
                                        @(variant.InStock ? $"{variant.StockQty} in stock" : "Out of stock")
                                    </small>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Add to Cart -->
                <div class="mt-4">
                    @if (Model.Product.DefaultVariant != null && Model.Product.DefaultVariant.InStock)
                    {
                        <button class="btn btn-primary btn-lg w-100" onclick="addToCart('@Model.Product.DefaultVariant.Id')">
                            <i class="bi bi-cart-plus"></i> Add to Cart
                        </button>
                        <div id="addToCartMessage" class="alert alert-success mt-2" style="display: none;">
                            Item added to cart! <a href="/cart">View Cart</a>
                        </div>
                    }
                    else
                    {
                        <button class="btn btn-secondary btn-lg w-100" disabled>
                            <i class="bi bi-x-circle"></i> Out of Stock
                        </button>
                    }
                </div>

                <div class="mt-3">
                    <a href="/products" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Products
                    </a>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function addToCart(variantId) {
            // Get existing cart from cookie
            let cart = getCookie('cart');
            let cartData = cart ? JSON.parse(cart) : { items: [] };

            // Check if item already in cart
            let existingItem = cartData.items.find(i => i.variantId === variantId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cartData.items.push({ variantId: variantId, quantity: 1 });
            }

            // Save to cookie (7 days expiration)
            document.cookie = `cart=${JSON.stringify(cartData)}; path=/; max-age=604800; SameSite=Lax`;

            // Show success message
            document.getElementById('addToCartMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('addToCartMessage').style.display = 'none';
            }, 3000);
        }

        function getCookie(name) {
            let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }

        console.log('Product details loaded: @Model.Product?.Title');
    </script>
}

